---
title: "set_limits"
author: "Mick Adriaansens"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(tidyr)
library(dplyr)
RED_values <-read.delim('/nesi/nobackup/uc04105/new_databases_May/final_tree_set/info_RED_clades_CPA_phylogeny_FTtree_lg_cat_gamma_7Nov.tsv',stringsAsFactors = TRUE, sep='\t')
RED_values$bootstrap <- as.numeric(RED_values$bootstrap)

RED_values <- RED_values %>%
      mutate(Bootstrap_support = factor(case_when(
        bootstrap > 949 ~ "Above threshold",
        TRUE ~ "Below threshold"
      )))

sign <- RED_values[RED_values$bootstrap > 949 & RED_values$children > 1,]



library(ggplot2)

#make plot to color them based if >95 bootstrap with full set of values
ggplot(data = RED_values, aes(x=RED, y=children, col=Bootstrap_support)) + geom_point() + ggtitle('Bifurcations and their termini(children) vs RED')
rm(RED_values)
ggsave("non_sign_plotplot.png")

```

```{r}
ggplot(data = sign, aes(x=RED, y=children, col='brown1')) + geom_point() + ggtitle('Significant bifurcations and their termini(children) vs RED')+ theme(legend.position="none")

ggsave("sign_plotplot.png") 

```

```{r}
RED_window <-read.delim('/home/mad149/RED_window.csv',stringsAsFactors = TRUE, sep=',') 
ggplot(data = RED_window, aes(x=RED, y=No.clades,))  +geom_smooth(se = FALSE, method = "loess", span = 0.2, linewidth = 1) + geom_point( col='purple', size=2.5) + ggtitle('Number clades (=>95) vs start RED of sliding window')+ theme(legend.position="none")
ggsave("Sliding_window.png") 
```

```{r, generate dataframe with all info}
Annotation1 <-read.delim('/nesi/nobackup/uc04105/new_databases_May/final_tree_set/CPA_full_tree_aligned_annotation_3nov.tsv',stringsAsFactors = TRUE, sep='\t')

Annotation2<-read.delim('/nesi/nobackup/uc04105/new_databases_May/final_tree_set/Red_informed_clade_20_lg_cat_gamma_RED_interval.tsv',stringsAsFactors = TRUE, sep='\t')



Annotation_final <- merge(Annotation1, Annotation2, by = 'Protein_id')

rm(Annotation1)
rm(Annotation2)

```


```{r}

Subgroup_red_clades <- Annotation_final %>% count(Subfamily) 
Subfamily_red_clades <- Annotation_final %>% count(Subfamily)
Subgroup_red_clades <- Annotation_final %>% count(Subgroup) 

Subclade_red_clades <- Annotation_final %>% count(Subclade) 
Clade_red_clades <- Annotation_final %>% count(Clade) 

```

```{r, labelclades}
library(dplyr)
Subgroup_red_clades <- Annotation_final %>% count(Subgroup)
Subgroup_red_clades<- Subgroup_red_clades %>% rename(clade_id = Subgroup)
Subgroup_red_clades <- merge(Subgroup_red_clades, sign, by ='clade_id')

sorted_asc <- sort(Subgroup_red_clades$RED)

Subgroup_red_clades <- Subgroup_red_clades[order(match(Subgroup_red_clades$RED, sorted_asc)), ]
Subgroup_red_clades$Taxa <- c('Subgroup')


Subgroup_red_clades <- Subgroup_red_clades %>%
  mutate(cumulative_value = cumsum(children))


ggplot(Subgroup_red_clades, aes(x=RED, y=cumulative_value)) + 
  geom_line() +geom_hline(yintercept = 0.95*66895, col = 'red',linetype =  'dashed') +
  geom_smooth(se = FALSE, method = "loess", span = 0.5, linewidth = 1) +geom_hline(yintercept = 0.975*66895, col = 'green',linetype =  'dashed') + ggtitle("Subgroup, RED interval 0.78-1")

Frequency<- c(rep(1, 5782))
Taxa <- c(rep('Subgroup', 5782))
RED <- c(Subgroup_red_clades$RED)
Subgroup_ridge <- data.frame(RED = RED, N = Frequency, Taxa=Taxa)
```

```{r, labelclades}
library(dplyr)
Subclade_red_clades <- Annotation_final %>% count(Subclade)
Subclade_red_clades<- Subclade_red_clades %>% rename(clade_id = Subclade)
Subclade_red_clades <- merge(Subclade_red_clades, sign, by ='clade_id')

sorted_asc <- sort(Subclade_red_clades$RED)

Subclade_red_clades <- Subclade_red_clades[order(match(Subclade_red_clades$RED, sorted_asc)), ]
Subclade_red_clades$Taxa <- c('Subclade')



Subclade_red_clades <- Subclade_red_clades %>%
  mutate(cumulative_value = cumsum(children))


ggplot(Subclade_red_clades, aes(x=RED, y=cumulative_value)) +
  geom_line() +geom_hline(yintercept = 0.95*66978, col = 'red',linetype =  'dashed') +  geom_smooth(se = FALSE, method = "loess", span = 0.5, linewidth = 1)+ggtitle("Subclade cumulative branches per noe, RED 0.48-0.728 ")

Frequency<- c(rep(1, 530))
RED <- c(Subclade_red_clades$RED)
Taxa <- c(rep('Subclade', 530))
Subclade_ridge <- data.frame(RED = RED, N = Frequency, Taxa=Taxa)

```


```{r, labelclades}
Clade_red_clades <- Annotation_final %>% count(Clade)
Clade_red_clades<- Clade_red_clades %>% rename(clade_id = Clade)
Clade_red_clades <- merge(Clade_red_clades, sign, by ='clade_id')

sorted_asc <- sort(Clade_red_clades$RED)

Clade_red_clades <- Clade_red_clades[order(match(Clade_red_clades$RED, sorted_asc)), ]
Clade_red_clades$Taxa <- c('Clade')

Clade_red_clades <- Clade_red_clades
Clade_red_clades <- Clade_red_clades %>%
  mutate(cumulative_value = cumsum(children))


ggplot(Clade_red_clades, aes(x=RED, y=cumulative_value)) +
  geom_line() +geom_hline(yintercept = 0.95*66978, col = 'red',linetype =  'dashed') +   geom_smooth(se = FALSE, method = "loess", span = 0.5, linewidth = 1) +ggtitle("Clade cumulative branches per node, RED 0.14-0.48")

Frequency<- c(rep(1, 39))
RED <- c(Clade_red_clades$RED)
Taxa <- c(rep('Clade', 39))
Clade_ridge <- data.frame(RED = RED, N = Frequency, Taxa=Taxa)
```






```{r}
#o.4721
Subfamily_red_clades <- Annotation_final %>% count(Subfamily)
Subfamily_red_clades<- Subfamily_red_clades %>% rename(clade_id = Subfamily)
Subfamily_red_clades <- merge(Subfamily_red_clades, sign, by ='clade_id')

sorted_asc <- sort(Subfamily_red_clades$RED)

Subfamily_red_clades <- Subfamily_red_clades[order(match(Subfamily_red_clades$RED, sorted_asc)), ]

Subfamily_red_clades$Taxa <- c('Subfamily')


Subfamily_red_clades <- Subfamily_red_clades %>%
  mutate(cumulative_value = cumsum(children))


ggplot(Subfamily_red_clades, aes(x=RED, y=cumulative_value)) +
  geom_line() +geom_hline(yintercept = 0.95*66978, col = 'red',linetype =  'dashed') +  geom_smooth(se = FALSE, method = "loess", span = 0.5, linewidth = 1)+ggtitle("Subfamily, cumulative branches per clade, RED 0.07-0.27 > (excluding CPA1/CPA2 split)")

Frequency<- c(rep(1, 15))
RED <- c(Subfamily_red_clades$RED)
Taxa <- c(rep('Subfamily', 15))

Subfamily_ridge <- data.frame(RED = RED, N = Frequency, Taxa=Taxa)
  
```






```{r}

#Clade_red_clades <-rbind(Clade_red_clades, start_point)
	
combined <- rbind(Subgroup_red_clades, Clade_red_clades, Subclade_red_clades, Subfamily_red_clades)

Ordering <-c('Subfamily', 'Clade','Subclade', 'Subgroup')
combined %>% mutate(Taxa = fct_relevel(Taxa, Ordering)) %>%ggplot( aes(x=RED, y=cumulative_value, group =Taxa, color=Taxa)) + 
  geom_line() +geom_hline(yintercept = 0.95*66978, col = 'red',linetype =  'dashed') + ggtitle("combined cumulative children")
ggsave("RED_intervals.png") 

#excludes terminal branches
```



```{r}
new <- rbind(Subgroup_ridge, Clade_ridge, Subclade_ridge, Subfamily_ridge)
```


```{r}
library(ggridges)
library(ggplot2)
library(forcats)

library(dplyr)

Ordering <-c('Subfamily', 'Clade','Subclade', 'Subgroup')
new %>% mutate(Taxa = fct_relevel(Taxa, Ordering)) %>% ggplot(aes(y=Taxa, x=RED,  fill=Taxa)) +geom_density_ridges(alpha=0.6, stat="binline", bins=25, scale = 0.85) +theme_ridges() 


ggsave("RED_Histogram.png") 

```


